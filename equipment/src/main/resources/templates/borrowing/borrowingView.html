<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"> <!--thymeleafの宣言-->

<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" th:href="@{/css/layout.css}">
	<title>貸出</title>
</head>

<body class="body">
	<h2>備品貸出画面</h2>
	<br>
	<h2 th:text="${detailName.equipmentName}"></h2>

	<!-- エラーメッセージ表示 -->
	<div class="fc_red" th:if="${errorMessages}">
		<ul>
			<li th:each="msg : ${errorMessages}" th:text="${msg}"></li>
		</ul>
	</div>

	<!-- 貸出成功メッセージ表示 -->
	<h4 class="success-message" th:if="${updateMessage}" th:text="${updateMessage}"></h4>

	<!-- 入れ子フォームを避けるため、テーブルとボタンを .table-wrapper に入れる -->
	<div>
	<!-- テーブルだけスクロール -->
	  <div class="table-wrapper">
	    <form id="borrowForm" th:action="@{/borrowingProcess}" method="post"
	         th:if="${itemDetail != null and !#lists.isEmpty(itemDetail)}">
	      <input type="hidden" name="name" th:value="${detailName.equipmentName}">
	      <table border="1" class="borrow-table">
						<colgroup>
							<col class="col-serial">
							<col class="col-user">
							<col class="col-start">
							<col class="col-limit">
							<col class="col-remarks">
							<col class="col-check">
						</colgroup>

						<tr class="front_label_color">
							<th>シリアルナンバー</th>
							<th>使用者</th>
							<th>貸出開始日</th>
							<th>返却予定日</th>
							<th>備考</th>
							<th>貸出</th>
						</tr>

						<tr th:each="item, stat : ${itemDetail}">
							<td class="col-serial">
								<span th:text="${item.parentStockCode}"></span>
								<input type="hidden" th:name="|serialMap[${item.equipmentId}]|"
									th:value="${item.parentStockCode}">
							</td>

							<td class="col-user">
								<select th:name="|staffNoMap[${item.equipmentId}]|">
									<option value="">選択してください</option>
									<option th:each="staff : ${staffName}" th:value="${staff.staffNo}"
										th:text="${staff.name}">
									</option>
								</select>
							</td>

							<td class="col-start">
								<input type="date" th:name="|startDateMap[${item.equipmentId}]|" th:value="${today}">
							</td>

							<td class="col-limit">
								<input type="date" th:name="|limitDateMap[${item.equipmentId}]|"
									th:value="${defaultLimit}">
							</td>

							<td class="col-remarks" th:text="${item.remarks}"></td>

							<td class="col-check">
								<input type="checkbox" name="equipmentIdList" th:value="${item.equipmentId}">
							</td>
						</tr>
					</table>
			</form>
		</div>
		
	  <!-- 貸出できる備品がないとき -->
		<h4 class="no-data" th:if="${itemDetail == null or #lists.isEmpty(itemDetail)}">
			全て貸出中です
		</h4>

		 <!-- 戻る用フォーム -->
		<form id="backForm" th:action="@{/detailBack}" method="get">
		    <input type="hidden" name="name" th:value="${detailName.equipmentName}">
		  </form>

		  <!-- ボタンはスクロール外 -->
		  <div class="table-buttons">
		     <button class="borrowingButton" type="submit" form="borrowForm"
		       th:if="${itemDetail != null and !#lists.isEmpty(itemDetail)}">貸出</button>
		     <button class="returnToTopButton" type="submit" form="backForm">戻る</button>
		   </div>
		 </div>




	<script>
		//画面を読み込み時に実行
		document.addEventListener("DOMContentLoaded", function () {

			// 貸出ボタン押下時の処理
			document.getElementById("borrowForm").addEventListener("submit", function (e) {

				// 今日の日付を取得し、時分秒ミリ秒を0に設定
				const today = new Date();
				today.setHours(0, 0, 0, 0);

				// 貸出開始日が本日より前の日付があるかどうかのフラグ
				let isBeforeToday = false;

				// テーブルの各行をループ処理
				document.querySelectorAll("tr").forEach(tr => {
					// チェックボックスが選択されていない行はスキップ
					const checkbox = tr.querySelector('input[name="equipmentIdList"]');
					if (!checkbox || !checkbox.checked) return;

					// 貸出開始日の入力フィールドを取得し、値がない場合はスキップ
					const startInput = tr.querySelector('input[name^="startDateMap"]');
					if (!startInput || !startInput.value) return;

					// 貸出開始日をDateオブジェクトに変換し、本日より前かどうかをチェック
					const startDate = new Date(startInput.value);

					// 時分秒ミリ秒を0に設定
					if (startDate < today) {
						isBeforeToday = true;
					}
				});

				// YES 
				if (isBeforeToday) {
					//confirm(はい・いいえ)
					const result = confirm("貸出開始日が本日より前ですが、更新しますか？");

					if (!result) {
						e.preventDefault(); // NO
					}
				}

			});

		});
	</script>


</body>

</html>