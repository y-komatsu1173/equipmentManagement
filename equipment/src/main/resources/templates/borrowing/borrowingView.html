<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"> <!--thymeleafの宣言-->

<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" th:href="@{/css/circulationLayout.css}">
	<title>貸出</title>
</head>

<body class="body">
	<div th:replace="~{common/layout_4block :: header}"></div>
	<h2 class="title">備品貸出画面</h2>
	<br>
	<h2 th:text="${detailName.equipmentName}"></h2>

	<!-- エラーメッセージヘッダー表示 -->
	<div th:if="${errorMessages != null and errorMessages.size() > 0}">
		<h4 class="fc_red">以下のエラーが発生しました。</h4>
		<h4 class="fc_red">更新できませんでした。再度入力してください。</h4>
	</div>

	<!-- エラーメッセージ表示 -->
	<div class="error-box" th:if="${errorMessages}">
		<ul class="error-list">
			<li th:each="msg : ${errorMessages}" th:text="${msg}"
				th:classappend="${msg.startsWith('【') ? 'error-title' : ''}">
			</li>
		</ul>
	</div>

	<!-- 貸出成功メッセージ表示 -->
	<h4 class="success-message" th:if="${updateMessage}" th:text="${updateMessage}"></h4>

	<!-- 入れ子フォームを避けるため、テーブルとボタンを .table-wrapper に入れる -->
	<div>
		<!-- テーブルだけスクロール -->
		<div class="table-wrapper">
			<form id="borrowForm" th:action="@{/borrowingProcess}" method="post"
				th:if="${itemDetail != null and !#lists.isEmpty(itemDetail)}">
				<input type="hidden" name="name" th:value="${detailName.equipmentName}">
				<table border="1" class="borrow-table">
					<colgroup>
						<col class="col-serial">
						<col class="col-user">
						<col class="col-start">
						<col class="col-limit">
						<col class="col-remarks">
						<col class="col-check">
					</colgroup>

					<tr class="front_label_color">
						<th>シリアルナンバー</th>
						<th>使用者</th>
						<th>貸出開始日</th>
						<th>返却予定日</th>
						<th>備考</th>
						<th>貸出</th>
					</tr>

					<!-- 備品リスト表示 -->
					<!-- エラー行は赤背景、正常行は黄背景 -->
					<tr th:each="item : ${itemDetail}" th:classappend="
					        ${errorEquipmentIds != null and errorEquipmentIds.contains(item.equipmentId)} ? 'row-error' :
					        (${warningEquipmentIds != null and warningEquipmentIds.contains(item.equipmentId)} ? 'row-warning' :
					        (${normalEquipmentIds != null and normalEquipmentIds.contains(item.equipmentId)} ? 'row-normal' : ''))
					    ">
						<!-- シリアルナンバー -->
						<td class="col-serial">
							<!-- シリアルナンバー表示 -->
							<span th:text="${item.parentStockCode}"></span>
							<!-- シリアルナンバーをhiddenで送信 -->
							<input type="hidden" th:name="|serialMap[${item.equipmentId}]|"
								th:value="${item.parentStockCode}">
						</td>

						<!-- 使用者選択 -->
						<td class="col-user">
							<!-- プルダウン選択 -->
							<select th:name="|staffNoMap[${item.equipmentId}]|">
								<option value="">選択してください</option>
								<!-- スタッフ名をループで表示 -->
								<option th:each="staff : ${staffName}" th:value="${staff.staffNo}"
									th:text="${staff.name}" th:selected="${prevStaffNoMap != null 
					                    and prevStaffNoMap[item.equipmentId.toString()] == staff.staffNo.toString()}">
								</option>
							</select>
						</td>

						<!-- 貸出開始日・返却予定日入力 -->
						<td class="col-start">
							<!-- 今日の日付をデフォルト値として設定 -->
							<input type="date" th:name="|startDateMap[${item.equipmentId}]|" th:value="${prevStartDateMap != null and prevStartDateMap[item.equipmentId.toString()] != null
					                     ? prevStartDateMap[item.equipmentId.toString()]
					                     : today}">
						</td>

						<!-- 返却予定日 -->
						<td class="col-limit">
							<!-- デフォルトの返却予定日を設定 -->
							<input type="date" th:name="|limitDateMap[${item.equipmentId}]|" th:value="${prevLimitDateMap != null and prevLimitDateMap[item.equipmentId.toString()] != null
					                     ? prevLimitDateMap[item.equipmentId.toString()]
					                     : defaultLimit}">
						</td>

						<!-- 備考 -->
						<td class="col-remarks">
							<div class="scroll-inner">
								<p th:text="${item.remarks}"></p>
							</div>
						</td>

						<!-- 貸出チェックボックス -->
						<td class="col-check">
							<input type="checkbox" name="equipmentIdList" th:value="${item.equipmentId}" th:checked="${prevEquipmentIdList != null
					                     and prevEquipmentIdList.contains(item.equipmentId)}">
						</td>
					</tr>
				</table>
			</form>
		</div>

		<!-- 貸出できる備品がないとき -->
		<h4 class="no-data" th:if="${itemDetail == null or #lists.isEmpty(itemDetail)}">
			全て貸出中です
		</h4>

		<!-- テーブル下のボタン -->
		<div class="table-buttons">
			<!-- 貸出ボタン（貸出できる備品があるときのみ表示） -->
			<button class="borrowingButton" type="submit" form="borrowForm"
				th:if="${itemDetail != null and !#lists.isEmpty(itemDetail)}">貸出</button>
			<!-- 戻るボタン -->
			<form th:action="@{/detailBack}" method="get">
				<input type="hidden" name="name" th:value="${detailName.equipmentName}">
				<button class="returnToTopButton" type="submit">戻る</button>
			</form>
		</div>
	</div>


	<script>
		// 貸出ボタン押下時の確認ダイアログ
		document.addEventListener("DOMContentLoaded", function () {

			// フォーム要素を取得
			const form = document.getElementById("borrowForm");
			// 二重防止フラグ	
			let alreadyConfirmed = false;

			form.addEventListener("submit", function (e) {

				// ★二重防止
				if (alreadyConfirmed) return;
				alreadyConfirmed = true;

				// 今日の日付と1年後の日付を取得
				const today = new Date();
				today.setHours(0, 0, 0, 0);

				// 1年後の日付を計算
				const oneYearLater = new Date(today);
				oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);

				// チェックされた行の貸出開始日と返却予定日を確認
				let isBeforeToday = false;
				let isLimitOverOneYear = false;

				// テーブルの各行をループ
				document.querySelectorAll("tr").forEach(tr => {
					// チェックボックスが選択されているか確認
					const checkbox = tr.querySelector('input[name="equipmentIdList"]');
					// チェックされていない場合はスキップ
					if (!checkbox || !checkbox.checked) return;

					// 貸出開始日と返却予定日の入力フィールドを取得
					const startInput = tr.querySelector('input[name^="startDateMap"]');
					// 返却予定日
					const limitInput = tr.querySelector('input[name^="limitDateMap"]');

					// 日付をチェック
					if (startInput && startInput.value) {
						const startDate = new Date(startInput.value);
						startDate.setHours(0, 0, 0, 0);
						if (startDate < today) isBeforeToday = true;
					}
					// 返却予定日
					if (limitInput && limitInput.value) {
						const limitDate = new Date(limitInput.value);
						limitDate.setHours(0, 0, 0, 0);
						if (limitDate >= oneYearLater) isLimitOverOneYear = true;
					}
				});

				// 確認ダイアログ表示
				if (isBeforeToday) {
					if (!confirm("貸出開始日が本日より前ですが、更新しますか？")) {
						e.preventDefault();
						alreadyConfirmed = false; // ★ 戻す
						return;
					}
				}

				// 返却予定日が1年以上先の場合
				if (isLimitOverOneYear) {
					if (!confirm(
						"返却日が1年以上先になっています。\n" +
						"1年おきに棚卸確認が必要になりますが、よろしいですか？"
					)) {
						e.preventDefault();
						alreadyConfirmed = false; // ★ 戻す
						return;
					}
				}
			});
		});
	</script>
	</script>


</body>

</html>